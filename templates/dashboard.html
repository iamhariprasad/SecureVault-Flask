{% extends "base.html" %}
{% block content %}

<div class="page-header animate-slide-down">
    <h1 class="page-title">Welcome back, {{ current_user.username }} üëã</h1>
    <p class="page-subtitle">Manage your encrypted files securely</p>
</div>

{# Statistics Cards #}
<div class="stats-grid animate-fade-in">
    <div class="stat-card">
        <div class="stat-label">Total Files</div>
        <div class="stat-value">{{ stats.total_files }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Total Storage</div>
        <div class="stat-value">{{ stats.total_size|format_size }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Status</div>
        <div class="stat-value" style="font-size: 1.5rem;">Protected</div>
    </div>
</div>

{# Search Bar #}
<div class="search-container">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search files by name...">
    </div>
</div>

{# Files Grid #}
{% if files|length == 0 %}
    <div class="empty-state animate-fade-in">
        <div class="empty-icon">üìÅ</div>
        <div class="empty-text">No files uploaded yet</div>
        <a href="{{ url_for('vault.upload') }}" class="btn btn-primary mt-2">Upload Your First File</a>
    </div>
{% else %}
    <div class="files-grid" id="filesGrid">
        {% for file in files %}
            <div class="file-card animate-fade-in" data-filename="{{ file.original_filename|lower }}">
                <div class="file-icon">
                    {% set ext = file.original_filename.split('.')[-1]|lower if '.' in file.original_filename else '' %}
                
                    {% if ext in ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp'] %}
                        <img src="{{ url_for('static', filename='icons/image.png') }}" class="icon-img">
                
                    {% elif ext in ['pdf'] %}
                        <img src="{{ url_for('static', filename='icons/pdf.png') }}" class="icon-img">
                
                    {% elif ext in ['doc', 'docx'] %}
                        <img src="{{ url_for('static', filename='icons/word-file.png') }}" class="icon-img">
                
                    {% elif ext in ['xls', 'xlsx', 'csv'] %}
                        <img src="{{ url_for('static', filename='icons/xls.png') }}" class="icon-img">
                
                    {% elif ext in ['ppt', 'pptx'] %}
                        <img src="{{ url_for('static', filename='icons/ppt.png') }}" class="icon-img">
                
                    {% elif ext in ['mp3', 'wav', 'aac', 'flac', 'ogg'] %}
                        <img src="{{ url_for('static', filename='icons/musicpng.png') }}" class="icon-img">
                
                    {% elif ext in ['mp4', 'mov', 'avi', 'mkv', 'wmv'] %}
                        <img src="{{ url_for('static', filename='icons/video.png') }}" class="icon-img">
                
                    {% elif ext in ['zip', 'rar', '7z', 'tar', 'gz'] %}
                        <img src="{{ url_for('static', filename='icons/archive.png') }}" class="icon-img">
                
                    {% else %}
                        <img src="{{ url_for('static', filename='icons/file.png') }}" class="icon-img">
                    {% endif %}
                </div>
                
                
                <div class="file-name">{{ file.original_filename }}</div>
                
                <div class="file-meta">
                    <span>
                        {% if file.file_size %}
                            {{ file.file_size|format_size }}
                        {% else %}
                            Unknown size
                        {% endif %}
                    </span>
                    <span>
                        {% if file.uploaded_at %}
                            {{ file.uploaded_at.strftime("%b %d, %Y") }}
                        {% else %}
                            Unknown date
                        {% endif %}
                    </span>
                </div>
                
                <div class="file-actions">
                    <form action="{{ url_for('vault.download', file_id=file._id) }}" method="GET" class="download-form">
                        <input type="password" 
                               name="password" 
                               placeholder="Password" 
                               required 
                               class="form-input"
                               style="margin-bottom: 0.5rem;">
                        <button type="submit" class="btn btn-primary btn-sm" style="width: 100%;">
                            Download
                        </button>
                    </form>
                    
                    <form action="{{ url_for('vault.delete_file', file_id=file._id) }}" 
                          method="POST" 
                          class="delete-form"
                          onsubmit="return confirm('Are you sure you want to delete this file? This action cannot be undone.');">
                        <button type="submit" class="btn btn-danger btn-sm" style="width: 100%;">
                            Delete
                        </button>
                    </form>
                </div>
            </div>
        {% endfor %}
    </div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    // Search functionality
    const searchInput = document.getElementById('searchInput');
    const filesGrid = document.getElementById('filesGrid');
    
    if (searchInput && filesGrid) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const fileCards = filesGrid.querySelectorAll('.file-card');
            
            fileCards.forEach(card => {
                const filename = card.getAttribute('data-filename');
                if (filename.includes(searchTerm)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    }
    
    // Auto-hide flash messages
    setTimeout(() => {
        const flashMessages = document.querySelectorAll('.flash-message');
        flashMessages.forEach(msg => {
            msg.style.animation = 'slideInRight 0.3s ease-out reverse';
            setTimeout(() => msg.remove(), 300);
        });
    }, 5000);
</script>
{% endblock %}
